const handler = async (m, { conn }) => {
  const cooldown = 600_000; // 10 دقائق
  const now = Date.now();
  const res = await m.db.query('SELECT exp, lastwork FROM usuarios WHERE id = $1', [m.sender]);
  const user = res.rows[0];
  const lastWork = Number(user?.lastwork) || 0;
  const remaining = Math.max(0, lastWork + cooldown - now);

  if (remaining > 0) {
    return conn.reply(m.chat, `⏳ عليك أن ترتاح لمدة *${msToTime(remaining)}* قبل أن تعمل مرة أخرى.`, m);
  }

  const xpGained = Math.floor(Math.random() * 6500);
  await m.db.query('UPDATE usuarios SET exp = exp + $1, lastwork = $2 WHERE id = $3', [xpGained, now, m.sender]);
  await conn.reply(m.chat, `🛠 ${pickRandom(work)} *${formatNumber(xpGained)} خبرة*`, m);
};

handler.help = ['عمل'];
handler.tags = ['اقتصاد'];
handler.command = /^عمل$/i;
handler.register = true;

export default handler;

function msToTime(duration) {
  const totalSeconds = Math.floor(duration / 1000);
  const minutes = Math.floor(totalSeconds / 60);
  const seconds = totalSeconds % 60;
  return `${minutes} دقيقة ${seconds} ثانية`;
}

function pickRandom(list) {
  return list[Math.floor(Math.random() * list.length)];
}

function formatNumber(num) {
  return num.toLocaleString('ar-EG');
}

const work = [
  'أنت خيميائي ماهر، تصنع جرعات غامضة لاكتشاف الأسرار القديمة. حصلت على',
  'تبحث عن الكنوز في أماكن منسية وتكتشف ثروة مخفية. حصلت على',
  'تقوم بحراسة مجموعات البوت وتكسب مقابل جهودك',
  'تساعد في إدارة مجموعة GataBot وتكافأ بـ',
  'تساعد في إدارة مجموعة LoliBot وتحصل على',
  'تعمل لدى شركة أمنية خاصة وتكسب',
  'تنظم مهرجان نبيذ فاخر وتربح',
  'تدرب التنانين وتكسب مهارات ومعرفة. حصلت على',
  'تصبح حدادًا أسطوريًا وتصنع أسلحة فريدة. حصلت على',
  'تكتشف غابة سحرية وتتواصل مع الطبيعة. حصلت على',
  'تروض وحوشًا شرسة باستخدام قدراتك. حصلت على',
  'تسافر عبر الزمن وتحل مشاكل تاريخية. حصلت على',
  'تكون مستشارًا ملكيًا وتوجه الحكام. حصلت على',
  'تبتكر تكنولوجيا ثورية وتغير العالم. حصلت على',
  'تسحر الناس بمهاراتك في الإقناع والذكاء. حصلت على',
  'تقود روبوتًا عملاقًا في معارك مذهلة. حصلت على',
  'تدير مزرعة تنانين وتعتني بها. حصلت على',
  'تعمل جاسوسًا وتكشف مؤامرات. حصلت على',
  'تستكشف الفضاء وتكتشف أسرار الكون. حصلت على',
  'تمارس السحر وتؤدي عروضًا مذهلة. حصلت على',
  'عالم مجنون يخترع أشياء غريبة. حصلت على',
  'تحمي المملكة من الغزاة. حصلت على',
  'تبحر في البحار وتكتشف جزرًا مليئة بالكنوز. حصلت على',
  'تتحرك في الظل وتقوم بمهام سرية. حصلت على',
  'طاهٍ بارع يبتكر أطباقًا لذيذة. حصلت على',
  'تحقق في الجرائم وتكشف الحقائق. حصلت على',
  'تفاوض مع الدول وتحافظ على السلام. حصلت على',
  'تكون شامانًا وتستدعي الطاقات الروحية. حصلت على',
  'تبتكر تطبيقات سحرية تغير حياة الناس. حصلت على',
  'تحارب في بطولات وتثبت مهاراتك. حصلت على',
  'تصمم مدنًا مستقبلية مذهلة. حصلت على',
  'تقرأ العقول وتتنبأ بالمستقبل. حصلت على',
  'مخرج سينمائي يبدع أفلامًا ملحمية. حصلت على',
  'تكتشف كوكبًا جديدًا في الفضاء. حصلت على',
  'خبير في البقاء يتغلب على الأخطار. حصلت على',
  'تعزف الموسيقى أمام جمهور كبير. حصلت على',
  'تستكشف أعماق البحر وتجد كنوزًا. حصلت على',
  'تصمم أزياء وتبتكر صيحات جديدة. حصلت على',
  'تبدأ ثورة وتقود الشعوب للحرية. حصلت على',
  'تكتشف علاجًا ينقذ الأرواح. حصلت على',
  'هاكر يكشف أسرارًا رقمية. حصلت على',
  'تكتشف نباتات نادرة بخصائص عجيبة. حصلت على',
  'تحقق في الأساطير وتكشف حقيقتها. حصلت على',
  'تنقب عن حضارات قديمة وتكشف أسرارها. حصلت على',
  'نمت مع المشرف. حصلت على',
  'لاعب محترف يحقق الانتصارات في البطولات. حصلت على',
];
